<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹æ¨èç³»ç»Ÿ - æ•°æ®ä»ªè¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; }
        h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 16px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-title { color: #999; font-size: 14px; text-transform: uppercase; margin-bottom: 10px; }
        .stat-value { color: #333; font-size: 36px; font-weight: bold; }
        .stat-delta { color: #10b981; font-size: 14px; margin-top: 5px; }
        .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .chart-title { font-size: 18px; color: #333; margin-bottom: 20px; font-weight: 600; }
        .table-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f3f4f6; padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
        td { padding: 15px; border-bottom: 1px solid #e5e7eb; color: #6b7280; }
        tr:hover { background: #f9fafb; }
        .platform-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .xiaohongshu { background: #ffe4e6; color: #be123c; }
        .douyin { background: #dbeafe; color: #1e40af; }
        .loading { text-align: center; color: white; font-size: 24px; padding: 50px; }
        .refresh-btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s; }
        .refresh-btn:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .last-update { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="controls">
                <div>
                    <h1>ğŸ“Š å†…å®¹æ¨èç³»ç»Ÿ - æ•°æ®ä»ªè¡¨æ¿</h1>
                    <p class="subtitle">å®æ—¶æŸ¥çœ‹å°çº¢ä¹¦å’ŒæŠ–éŸ³å†…å®¹é‡‡é›†æ•°æ®</p>
                </div>
                <div style="text-align: right;">
                    <button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    <div class="last-update" id="lastUpdate">æœ€åæ›´æ–°: --</div>
                </div>
            </div>
        </div>
        
        <!-- å†…å®¹çˆ¬è™«æœç´¢æ¥å£ -->
        <div id="crawler-search-container"></div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-title">ğŸ“ æ€»å†…å®¹æ•°</div>
                <div class="stat-value" id="totalCount">--</div>
                <div class="stat-delta">åŠ è½½ä¸­...</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ¨ å°çº¢ä¹¦</div>
                <div class="stat-value" id="xhsCount">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸµ æŠ–éŸ³</div>
                <div class="stat-value" id="douyinCount">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">â° æœ€æ–°é‡‡é›†</div>
                <div class="stat-value" style="font-size: 20px;" id="latestTime">--</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-card">
                <div class="chart-title">å¹³å°åˆ†å¸ƒ</div>
                <canvas id="platformChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">æ¯æ—¥é‡‡é›†è¶‹åŠ¿</div>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <div class="chart-title">æœ€æ–°å†…å®¹åˆ—è¡¨</div>
            <table id="contentTable">
                <thead>
                    <tr>
                        <th>å¹³å°</th>
                        <th>å†…å®¹ID</th>
                        <th>é‡‡é›†æ—¶é—´</th>
                        <th>æ•°æ®é¢„è§ˆ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="4" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Supabaseé…ç½® - ä½¿ç”¨åŒ¿åå…¬é’¥ï¼ˆå®‰å…¨çš„ï¼Œåªè¯»æƒé™ï¼‰
        // ä½¿ç”¨window.supabaseClienté¿å…é‡å¤å£°æ˜
        if (typeof window.supabaseClient === 'undefined') {
            const supabaseUrl = 'https://qxtsitaebqmiphnwmvky.supabase.co'
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dHNpdGFlYnFtaXBobndtdmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY2ODAwMTEsImV4cCI6MjA1MjI1NjAxMX0.KFN_BhYWA_kxPP-L4OkEY24XCnfVIiLWX4v4P8vCFJ4'
            window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)
        }
        // ä½¿ç”¨å·²å­˜åœ¨çš„supabaseClientï¼Œé¿å…é‡å¤å£°æ˜
        // ç›´æ¥ä½¿ç”¨window.supabaseClientï¼Œä¸å£°æ˜æ–°å˜é‡
        if (!window.supabase) {
            window.supabase = window.supabaseClient;
        }

        let platformChart, trendChart;

        async function loadData() {
            try {
                // ä¼˜å…ˆä»localStorageåŠ è½½çˆ¬å–çš„æ•°æ®
                const localData = JSON.parse(localStorage.getItem('crawled_data') || '[]');
                if (localData && localData.length > 0) {
                    console.log(`ä»æœ¬åœ°å­˜å‚¨åŠ è½½ ${localData.length} æ¡æ•°æ®`);
                    updateStats(localData);
                    updateCharts(localData);
                    updateTable(localData);
                    document.getElementById('lastUpdate').textContent = 'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN');
                    return; // æœ‰æœ¬åœ°æ•°æ®å°±ä¸åŠ è½½Supabaseäº†
                }
                
                // å¦‚æœæ²¡æœ‰æœ¬åœ°æ•°æ®ï¼Œå°è¯•ä»SupabaseåŠ è½½
                try {
                    const supabaseClient = window.supabase || window.supabaseClient;
                    if (supabaseClient && typeof supabaseClient.from === 'function') {
                        const { data, error } = await supabaseClient
                            .from('content_raw')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (!error && data && data.length > 0) {
                            console.log(`ä»SupabaseåŠ è½½ ${data.length} æ¡æ•°æ®`);
                            updateStats(data);
                            updateCharts(data);
                            updateTable(data);
                            document.getElementById('lastUpdate').textContent = 'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN');
                            return;
                        }
                    }
                } catch (supabaseError) {
                    console.log('SupabaseåŠ è½½å¤±è´¥:', supabaseError.message);
                }
                
                // å¦‚æœéƒ½æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                console.log('æ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                updateStats([]);
                updateCharts([]);
                updateTable([]);
                document.getElementById('lastUpdate').textContent = 'æœ€åæ›´æ–°: æš‚æ— æ•°æ®';
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºç©ºçŠ¶æ€
                updateStats([]);
                updateCharts([]);
                updateTable([]);
            }
        }

        function updateStats(data) {
            if (!data || !Array.isArray(data)) {
                data = [];
            }
            
            const xhsData = data.filter(d => d && d.platform === 'xiaohongshu')
            const douyinData = data.filter(d => d && d.platform === 'douyin')
            
            const totalCountEl = document.getElementById('totalCount');
            const xhsCountEl = document.getElementById('xhsCount');
            const douyinCountEl = document.getElementById('douyinCount');
            const latestTimeEl = document.getElementById('latestTime');
            
            if (totalCountEl) totalCountEl.textContent = data.length || 0;
            if (xhsCountEl) xhsCountEl.textContent = xhsData.length || 0;
            if (douyinCountEl) douyinCountEl.textContent = douyinData.length || 0;
            
            if (data.length > 0 && data[0].created_at) {
                try {
                    const latest = new Date(data[0].created_at);
                    if (latestTimeEl) {
                        latestTimeEl.textContent = latest.toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }
                } catch (e) {
                    if (latestTimeEl) latestTimeEl.textContent = '--';
                }
            } else {
                if (latestTimeEl) latestTimeEl.textContent = '--';
            }
        }

        function updateCharts(data) {
            if (!data || !Array.isArray(data)) {
                data = [];
            }
            
            const xhsCount = data.filter(d => d && d.platform === 'xiaohongshu').length;
            const douyinCount = data.filter(d => d && d.platform === 'douyin').length;

            const platformChartEl = document.getElementById('platformChart');
            if (platformChartEl) {
                if (platformChart) platformChart.destroy();
                platformChart = new Chart(platformChartEl, {
                    type: 'doughnut',
                    data: {
                        labels: ['å°çº¢ä¹¦', 'æŠ–éŸ³'],
                        datasets: [{
                            data: [xhsCount, douyinCount],
                            backgroundColor: ['#ff2442', '#00f0ff']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            const dailyData = {};
            data.forEach(item => {
                if (item && item.created_at) {
                    try {
                        const date = new Date(item.created_at).toLocaleDateString('zh-CN');
                        dailyData[date] = (dailyData[date] || 0) + 1;
                    } catch (e) {
                        // å¿½ç•¥æ—¥æœŸè§£æé”™è¯¯
                    }
                }
            });

            const trendChartEl = document.getElementById('trendChart');
            if (trendChartEl) {
                if (trendChart) trendChart.destroy();
                const labels = Object.keys(dailyData).length > 0 ? Object.keys(dailyData) : ['æš‚æ— æ•°æ®'];
                const values = Object.keys(dailyData).length > 0 ? Object.values(dailyData) : [0];
                
                trendChart = new Chart(trendChartEl, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ¯æ—¥é‡‡é›†é‡',
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">æš‚æ— æ•°æ®ï¼Œè¯·ä½¿ç”¨æœç´¢åŠŸèƒ½çˆ¬å–æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.slice(0, 20).map(item => {
                if (!item) return '';
                const platform = item.platform || 'unknown';
                const id = item.id || item.note_id || 'N/A';
                const created_at = item.created_at || item.publish_time || new Date().toISOString();
                const title = item.title || item.desc || 'æ— æ ‡é¢˜';
                const likes = item.liked_count || item.likes || 0;
                const rawData = item.raw_data ? JSON.stringify(item.raw_data).substring(0, 100) : title;
                
                return `
                <tr>
                    <td><span class="platform-badge ${platform}">${platform === 'xiaohongshu' ? 'å°çº¢ä¹¦' : 'æŠ–éŸ³'}</span></td>
                    <td>${id.length > 8 ? id.substring(0, 8) + '...' : id}</td>
                    <td>${new Date(created_at).toLocaleString('zh-CN')}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${rawData}${rawData.length >= 100 ? '...' : ''}</td>
                    <td>${likes}</td>
                </tr>
            `;
            }).filter(html => html).join('')
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        loadData()
        // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
        setInterval(loadData, 60000)
    </script>
    
    <!-- ç™»å½•ç®¡ç†ç•Œé¢è„šæœ¬ -->
    <script src="login_interface.js"></script>
    
    <!-- å†…å®¹çˆ¬è™«æœç´¢æ¥å£è„šæœ¬ - å¿…é¡»åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œ -->
    <script>
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†åŠ è½½æœç´¢æ¥å£è„šæœ¬
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                loadSearchInterface();
            });
        } else {
            loadSearchInterface();
        }
        
        function loadSearchInterface() {
            const script = document.createElement('script');
            script.src = 'inject_to_webpage.js';
            script.onerror = function() {
                console.error('âŒ æ— æ³•åŠ è½½æœç´¢æ¥å£è„šæœ¬ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
            };
            script.onload = function() {
                console.log('âœ… æœç´¢æ¥å£è„šæœ¬åŠ è½½æˆåŠŸ');
            };
            document.head.appendChild(script);
        }
    </script>
    <script>
        // é…ç½®APIåœ°å€
        window.API_BASE_URL = window.API_BASE_URL || 'http://localhost:5001';
        
        // å¢å¼ºloadDataå‡½æ•°ï¼Œæ”¯æŒä»localStorageè¯»å–çˆ¬å–çš„æ•°æ®
        const originalLoadData = window.loadData;
        window.loadData = async function() {
            // å…ˆå°è¯•ä»localStorageåŠ è½½çˆ¬å–çš„æ•°æ®
            try {
                const localData = JSON.parse(localStorage.getItem('crawled_data') || '[]');
                if (localData.length > 0) {
                    console.log(`ä»æœ¬åœ°å­˜å‚¨åŠ è½½ ${localData.length} æ¡çˆ¬å–æ•°æ®`);
                    updateStats(localData);
                    updateCharts(localData);
                    updateTable(localData);
                    document.getElementById('lastUpdate').textContent = 'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN');
                }
            } catch (e) {
                console.log('æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥:', e);
            }
            
            // ç„¶åå°è¯•ä»SupabaseåŠ è½½ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
            if (originalLoadData) {
                try {
                    await originalLoadData();
                } catch (e) {
                    console.log('SupabaseåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                }
            }
        };
        
        // ä¿®æ”¹inject_to_webpage.jsä¸­çš„ä¿å­˜å‡½æ•°
        window.saveCrawlDataToPage = function(notes, keyword) {
            try {
                const storageKey = 'crawled_data';
                let existingData = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                const newData = notes.map(note => ({
                    id: note.note_id || note.id || Date.now() + Math.random(),
                    platform: 'xiaohongshu',
                    created_at: new Date().toISOString(),
                    keyword: keyword,
                    raw_data: note
                }));
                
                existingData = [...newData, ...existingData].slice(0, 1000);
                localStorage.setItem(storageKey, JSON.stringify(existingData));
                
                console.log(`âœ… å·²ä¿å­˜ ${notes.length} æ¡æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨`);
                
                // åˆ·æ–°æ•°æ®
                if (typeof loadData === 'function') {
                    setTimeout(loadData, 500);
                }
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        };
    </script>
</body>
</html>
